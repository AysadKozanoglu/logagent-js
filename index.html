<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="./img/favicon.ico">

	<title>logagent-js</title>

        <link href="./css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="./css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="./css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="./css/highlight.css">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body class="homepage">

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            

            <!-- Main title -->
            <a class="navbar-brand" href=".">logagent-js</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#logagent-js">logagent-js</a></li>
        
    
        <li class="main "><a href="#features">Features</a></li>
        
            <li><a href="#parser">Parser</a></li>
        
            <li><a href="#command-line-tool">Command Line Tool</a></li>
        
            <li><a href="#inputs">Inputs</a></li>
        
            <li><a href="#processing">Processing</a></li>
        
            <li><a href="#reliable-log-shipping-with-disk-buffer">Reliable log shipping with disk buffer</a></li>
        
            <li><a href="#outputs">Outputs</a></li>
        
            <li><a href="#deployment-options">Deployment options</a></li>
        
            <li><a href="#api">API</a></li>
        
    
        <li class="main "><a href="#installation">Installation</a></li>
        
            <li><a href="#preparation-install-nodejs">Preparation: Install Node.js</a></li>
        
    
        <li class="main "><a href="#install-logagent-js-with-npm">Install logagent-js with npm</a></li>
        
            <li><a href="#install-logagent-as-linux-or-mac-os-x-service-for-logsene">Install logagent as Linux or Mac OS X service for Logsene</a></li>
        
            <li><a href="#install-logagent-as-syslog-container-for-docker-logs">Install logagent as syslog container for Docker logs</a></li>
        
            <li><a href="#install-logagent-as-heroku-log-drain">Install logagent as Heroku log drain</a></li>
        
            <li><a href="#command-line-parameters-for-logagent">Command Line Parameters for logagent</a></li>
        
            <li><a href="#command-line-examples">Command Line Examples</a></li>
        
    
        <li class="main "><a href="#log-parser-and-pattern-definitions">Log Parser and pattern definitions</a></li>
        
            <li><a href="#how-does-the-parser-work">How does the parser work?</a></li>
        
    
        <li class="main "><a href="#nodejs-api-for-logagent-js">Node.js API for logagent-js</a></li>
        
    
        <li class="main "><a href="#related-packages">Related packages</a></li>
        
    
        <li class="main "><a href="#support">Support</a></li>
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<p><a href="https://heroku.com/deploy?template=https://github.com/sematext/logagent-js"><img alt="Deploy" src="https://www.herokucdn.com/deploy/button.png" /></a> - <a href="http://blog.sematext.com/2016/02/18/how-to-ship-heroku-logs-to-logsene-managed-elk-stack/">read more</a></p>
<h1 id="logagent-js">logagent-js</h1>
<p>Smart Log Parser and Log Shipper written in Node. </p>
<h1 id="features">Features</h1>
<p>This project contains a liraray and patterns for log parsing and cli tools and installers to use logagent-js as log shipper having following features: </p>
<h2 id="parser">Parser</h2>
<ul>
<li>log format detection and intelligent pattern matching </li>
<li>pattern library included </li>
<li>recognition of Date and Number fields</li>
<li>easy to extend with custom patterns and JS transform functions</li>
<li>replace sensitive data with SHA-1 hash codes</li>
<li>GeoIP lookup with automatic GeoIP db updates (maxmind geopip-lite files)</li>
</ul>
<h2 id="command-line-tool">Command Line Tool</h2>
<ul>
<li>log format converter (e.g. text to JSON, line delimited JSON or YAML) </li>
<li>
<p>Log shipper for <a href="http://www.sematext.com/logsene/">Logsene</a></p>
</li>
<li>
<p>including cli, launchd (Mac OS X), upstart and systemd (Linux) service installer</p>
</li>
<li>disk buffer for failed inserts during network outage</li>
</ul>
<h2 id="inputs">Inputs</h2>
<ul>
<li>Standart input (stdin) taking the output stream from any Linux cli tool</li>
<li>patterns are applied to each incomming text lines, including support for multi-line patters, e.g. for Java Stack Traces and JSON parser. </li>
<li>Syslog Server (UDP) - reception of Syslog messages via UDP. The parser is applied to the message field. </li>
<li><a href="https://github.com/sematext/logagent-js#logagent-as-heroku-log-drain">Heroku Log Drain</a></li>
<li>CloudFoundry Log Drain</li>
</ul>
<h2 id="processing">Processing</h2>
<ul>
<li>logagent-js applies the patterns defined in ```patterns.yml' to all logs to create structured output from plain text lines</li>
<li>GeoIP lookups for IP adress fields, including download and update of the GeoIP lite database from Maxmind</li>
</ul>
<h2 id="reliable-log-shipping-with-disk-buffer">Reliable log shipping with disk buffer</h2>
<p>Logagent stores parsed logs to disk in case the network connection to the Elasticsearch API fails. Logagent retries to ship the logs later, when the network or Elasticsearch server is available again.  </p>
<h2 id="outputs">Outputs</h2>
<ul>
<li>bulk inserts to <a href="http://sematext.com/logsene">Logsene</a> / Elasticsearch API</li>
<li>JSON, line delimited JSON and YML to stadard output  </li>
</ul>
<h2 id="deployment-options">Deployment options</h2>
<ul>
<li>Deployable as system service: systemd, upstart (Linux) launchd (Mac OS X)setups </li>
<li>Docker Container to receive logs via syslog</li>
<li>Deployement to Heroku as Heroku Log drain</li>
</ul>
<h2 id="api">API</h2>
<ul>
<li>Node.js module to integrate parsers into Node.js programs</li>
<li>logagent-js is part of <a href="https://github.com/sematext/spm-agent-docker">SPM for Docker</a> to parse Container Logs</li>
</ul>
<h1 id="installation">Installation</h1>
<h2 id="preparation-install-nodejs">Preparation: Install Node.js</h2>
<p>Official Node.js <a href="https://nodejs.org/en/download/">downloads and instructions</a>.
E.g. for Debian/Ubuntu:</p>
<pre><code>curl -sL https://deb.nodesource.com/setup_4.x | sudo -E bash -
sudo apt-get install -y nodejs
</code></pre>

<h1 id="install-logagent-js-with-npm">Install logagent-js with npm</h1>
<pre><code>npm i -g logagent-js
# Test to ship your logs to Logsene, parsed with timestamps - output on console in YAML format (-y)
logagent -y /var/log/*.log
</code></pre>

<h2 id="install-logagent-as-linux-or-mac-os-x-service-for-logsene">Install logagent as Linux or Mac OS X service for Logsene</h2>
<ol>
<li>Get a free account at <a href="https://apps.sematext.com/users-web/register.do">sematext.com/spm</a>  </li>
<li><a href="https://apps.sematext.com/logsene-reports/registerApplication.do">create a Logsene App</a> to obtain an App Token for <a href="http://www.sematext.com/logsene/">Logsene</a> </li>
<li>Install logagnet as system service
Logagent detects the init system and installs systemd or upstart service scripts. 
On Mac OS X it creates a launchd service. Simply run:</li>
</ol>
<pre><code>npm i logagent-js -g # install logagent package globally
sudo logagent-setup LOGSENE_TOKEN
</code></pre>

<p>The setup script generates a configuraton file in <code>/etc/sematext/logagent.conf</code>.
This file includes the CLI parameters for logagent running as service.
The default settings ship all logs from <code>`/var/log/**/*.log</code> to Logsene. </p>
<p>Location of service scripts:
- upstart: /etc/init/logagent.conf
- systemd: /etc/systemd/system/logagent.service
- launchd: /Library/LaunchDaemons/com.sematext.logagent.plist</p>
<p>Start/stop service: 
- upstart: <code>service logagent stop/start</code>
- systemd: <code>systemctl stop/start logagent</code>
- lauchnchd: <code>launchctl start/stop com.sematext.logagent</code></p>
<h2 id="install-logagent-as-syslog-container-for-docker-logs">Install logagent as syslog container for Docker logs</h2>
<p>Build the image and start logagent with the LOGSENE_TOKEN</p>
<pre><code>git clone https://github.com/sematext/logagent-js.git
cd logagent-js
docker build -t logagent . 
docker run -p 514:514/udp -e LOGSENE_TOKEN=YOUR_LOGSENE_TOKEN  -d --name logagent --restart=always logagent
</code></pre>

<p>Run your container with syslog driver</p>
<pre><code>export $DOCKER_HOSTNAME=192.168.99.100
docker run --log-driver=syslog  --log-opt syslog-address=udp://$DOCKER_HOSTNAME:514 --log-opt tag=&quot;{{.ImageName}}#{{.Name}}#{{.ID}}&quot; -p 9003:80 -d nginx
curl $DOCKER_HOSTNAME:9003
</code></pre>

<p><strong>Container Options</strong>
- Pass a custom pattern file</p>
<pre><code>-v $PWD/patterns.yml:/patterns.yml -e PATTERN_FILE=/patterns.yml
</code></pre>

<ul>
<li>Set any CLI option
e.g. print logs in YML format to console (default is "-s" - silent)</li>
</ul>
<pre><code>-e LOGAGENT_OPTIONS=&quot;-y&quot;
</code></pre>

<p>To view realtime logs in the Web Browser with rtail, simply add the options for rtail and open the http port for rtail-server UI. Please note: <em>rtail UI might be slow for high log volumes</em></p>
<pre><code>export LOGAGENT_OPTIONS=&quot;-s --rtail-host $HOSTNAME --rtail-web-port 80 --rtail-port 9999&quot;
docker run -p 8080:80 -p 514:514/udp -e LOGAGENT_OPTIONS -e LOGSENE_TOKEN=YOUR_LOGSENE_TOKEN  -d --name logagent --restart=always logagent
</code></pre>

<ul>
<li>Set Node.js Memory limits</li>
</ul>
<pre><code>-e NODE_OPTIONS=&quot;--max-old-space-size=200&quot;
</code></pre>

<h2 id="install-logagent-as-heroku-log-drain">Install logagent as Heroku log drain</h2>
<p><a href="http://www.heroku.com">Heroku</a> can forward logs to a <a href="https://devcenter.heroku.com/articles/log-drains">Log Drain</a> </p>
<pre><code>heroku drain:add --app HerokuAppName URL 
</code></pre>

<p>To receive Heroku logs, logagent-js can be deployed to Heroku. It acts as HTTPS log drain. </p>
<ol>
<li>Get a free account <a href="https://apps.sematext.com/users-web/register.do">apps.sematext.com</a>  </li>
<li>Create a <a href="http://www.sematext.com/logsene/">Logsene</a> App to obtain the Logsene Token</li>
<li>Deploy logagent-js to Heroku </li>
</ol>
<p><a href="https://heroku.com/deploy?template=https://github.com/sematext/logagent-js"><img alt="Deploy" src="https://www.herokucdn.com/deploy/button.png" /></a> or use the following commands:</p>
<p><code>git clone https://github.com/sematext/logagent-js.git
  cd logagent-js
  heroku login 
  heroku create
  git push heroku master</code>
4. Add the the log drain.<br />
  The URL format is https://loggerAppName.herokuapps.com/LOGSENE_TOKEN
  Use following command, using the dynamically given name from "heroku create".</p>
<p><code>export LOGSENE_TOKEN=YOUR_LOGSENE_TOKEN
  heroku drains:add --app YOUR_HEROKU_MAIN_APPLICATION  `heroku info -s | grep web-url | cut -d= -f2`$LOGSENE_TOKEN</code>
Now you can see your logs in Logsene, define Alert-Queries or use Kibana 4 for Dashboards. </p>
<ol>
<li>Scale logagent-js service on Heroku</li>
</ol>
<p>In case of high log volume, scale logagent-js  on demand using </p>
<pre><code>heroku scale web=3
</code></pre>

<h2 id="command-line-parameters-for-logagent">Command Line Parameters for logagent</h2>
<table>
<thead>
<tr>
<th>Paramater</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>-f</strong> patterns.yml</td>
<td>file with pattern definitions</td>
</tr>
<tr>
<td><strong>-y</strong></td>
<td>prints parsed messages in YAML format to stdout</td>
</tr>
<tr>
<td><strong>-p</strong></td>
<td>pretty json output</td>
</tr>
<tr>
<td><strong>-s</strong></td>
<td>silent, print no logss, only throughput and memory usage on exit</td>
</tr>
<tr>
<td><strong>-t</strong> token</td>
<td><a href="http://sematext.com/logsene">Logsene</a> App Token to insert parsed records into Logsene.</td>
</tr>
<tr>
<td><strong>-g</strong> glob-pattern</td>
<td>use a <a href="https://www.npmjs.com/package/glob">glob</a> pattern to watch log files e.g. -g "{/var/log/<em>.log,/Users/stefan/</em>/*.log}"</td>
</tr>
<tr>
<td><strong>--logsene-tmp-dir</strong>  path</td>
<td>directory to store buffered logs during network outage</td>
</tr>
<tr>
<td><strong>-u</strong> UDP_PORT</td>
<td>starts a syslogd UDP listener on the given port to act as syslogd</td>
</tr>
<tr>
<td><strong>-n</strong> name</td>
<td>name for the source only when stdin is used, important to make multi-line patterns working on stdin because the status is tracked by the source name.</td>
</tr>
<tr>
<td><strong>--heroku</strong> PORT</td>
<td>listens for heroku logs (http drain / framed syslog over http)</td>
</tr>
<tr>
<td><strong>--cfhttp</strong> PORT</td>
<td>listens for CloudFoundry logs (syslog over http)</td>
</tr>
<tr>
<td><strong>--rtail-port</strong></td>
<td>forwards logs via udp to <a href="http://rtail.org/">rtail</a> server</td>
</tr>
<tr>
<td><strong>--rtail-host</strong> hostname</td>
<td><a href="http://rtail.org/">rtail</a> server (UI for realtime logs), default: localhost</td>
</tr>
<tr>
<td><strong>list of files</strong>, e.g. /var/log/*.log</td>
<td>watched by <a href="https://www.npmjs.com/package/tail-forever">tail-forever</a> starting at end of file to watch</td>
</tr>
</tbody>
</table>
<p>The default output is line delimited JSON.</p>
<h2 id="command-line-examples">Command Line Examples</h2>
<pre><code># Be Evil: parse all logs 
# stream logs to Logsene 1-Click ELK stack 
logagent -t LOGSENE_TOKEN /var/log/*.log 
# Act as syslog server on UDP and forward messages to Logsene
logagent -t LOGSENE_TOKEN -u 1514 
# Act as syslog server on UDP and write YAML formated messages to console
logagent -u 1514 -y  
</code></pre>

<p>Use a <a href="https://www.npmjs.com/package/glob">glob</a> pattern to build the file list </p>
<pre><code>logagent -t LOGSENE_TOKEN -g &quot;{/var/log/*.log,/opt/myapp/*.log}&quot; 
</code></pre>

<p>Watch selective log output on console by passing logs via stdin and format in YAML</p>
<pre><code>tail -f /var/log/access.log | logagent -y 
tail -f /var/log/system.log | logagent -f my_own_patterns.yml  -y 
</code></pre>

<p>Ship logs to rtail and Logsene to view logs in real-time in rtail and store logs in Logsene</p>
<pre><code># rtail don't need to be installed, logagent uses the rtail protocol
logagent -t $LOGSENE_TOKEN --rtail-host myrtailserver --rtail-port 9999 /var/log/*.log
</code></pre>

<p>Logagent can start the rtail web-server (in-process, saving memory), open browser with http://localhost:8080</p>
<pre><code># logagent has no dependency to rtail, to keep the package small
sudo npm i rtail -g
logagent -s -t $LOGSENE_TOKEN --rtail-web-port 8080 --rtail-port 9999 /var/log/*.log
</code></pre>

<p>And of course you can combine rtail and Logagent in the traditional way, simply connect both via unix pipes. An example with rtail and Logsene storage and charts:
<img alt="" src="http://g.recordit.co/usjLitb3Dd.gif" /></p>
<h1 id="log-parser-and-pattern-definitions">Log Parser and pattern definitions</h1>
<h2 id="how-does-the-parser-work">How does the parser work?</h2>
<p>The parser detects log formats based on a pattern library (yaml file) and converts it to a JSON Object:</p>
<ul>
<li>find matching regex in pattern library</li>
<li>tag it with the recognized type</li>
<li>extract fields using regex</li>
<li>if 'autohash' is enabled, sensitive data is replaced with its sha1 hash code</li>
<li>parse dates and detect date format
  (use 'ts' field for date and time combined) </li>
<li>create ISO timestamp in '@timestamp' field</li>
<li>transform function to manipulate parsed objects</li>
<li>unmatched lines end up with timestamp and original line in the message field</li>
<li>JSON lines are parsed, and scanned for @timestamp and time fields (logstash and bunyan format)</li>
<li>default patterns for many applications (see below)</li>
<li>Heroku logs</li>
</ul>
<p>The default pattern definition file include already patterns for:
- MongoDB, 
  - MySQL, 
  - Nginx, 
  - Redis, 
  - Elasticsearch
  - Apache 
    - Webserver (httpd), 
    - Zookeeper, 
    - Cassandra, 
    - Kafka,
    - HBase HDFS Data Node,
    - HBase Region Server,
    - Hadoop YARN Node Manager, 
    - Apache SOLR,
  - various Linux/Mac OS X system log files </p>
<p>The file format is based on <a href="https://nodeca.github.io/js-yaml/">JS-YAML</a>, in short:</p>
<ul>
<li>
<ul>
<li>indicates an  array</li>
</ul>
</li>
<li>!js/regexp - indicates a JS regular expression</li>
<li>!!js/function &gt; - indicates a JS function </li>
</ul>
<p>Properties:
- patterns - the list of patterns, each pattern starts with "-"
- match: A group of patterns for a specific log source
- regex: a JS regular expression 
- fields: the field list of extracted match groups from the regex
- type: the type used in Logsene (Elasticsearch Mapping)
- dateFormat: the format of the special fields 'ts', if the date format matches, a new field @timestamp is generated
- transform: a JS function to manipulate the result of regex and date parsing</p>
<p>Example:</p>
<pre><code># Sensitive data can be replaced with a hashcode (sha1)
# it applies to fields matching the field names by a regular expression
# Note: this function is not optimized (yet) and might take 10-15% of performance
autohash: !!js/regexp /user|password|email|credit_card_number|payment_info/i
# activate GeoIP lookup
geoIP: true
# logagent updates geoip db files automatically
# pls. note write access to this directory is required
maxmindDbDir: /tmp/
patterns: 
  - # APACHE  Web Logs
  sourceName: httpd
  match: 
    # Common Log Format
    - regex:        !!js/regexp /([0-9a-f.:]+)\s+(-|.+?)\s+(-|.+?)\s+\[([0-9]{2}\/[a-z]{3}\/[0-9]{4}\:[0-9]{2}:[0-9]{2}:[0-9]{2}[^\]]*)\] \&quot;(\S+?)\s(\S*?)\s{0,1}(\S+?)\&quot; ([0-9|\-]+) ([0-9|\-]+)/i
      type: apache_access_common
      fields:       [client_ip,remote_id,user,ts,method,path,http_version,status_code,size]
      dateFormat: DD/MMM/YYYY:HH:mm:ss ZZ
      # lookup geoip info for the field client_ip
      geoIP: client_ip
      transform: !!js/function &gt;
        function (p) {
          p.message = p.method + ' ' + p.path
        }
</code></pre>

<p>The default patterns are <a href="./patterns.yml">here</a> - contributions are welcome.</p>
<h1 id="nodejs-api-for-logagent-js">Node.js API for logagent-js</h1>
<pre><code>npm i logagent-js --save
</code></pre>

<p>Use the Logparser module in your source code</p>
<pre><code>var Logparser = require('logagent-js')
var lp = new Logparser('./patterns.yml')
lp.parseLine('log message', 'source name', function (err, data) {
    if(err) {
      console.log('line did not match with any pattern')
    }
    console.log(JSON.stringify(data))
})
</code></pre>

<p>To test patterns or convert logs from text to JSON use the command line tool 'logagent'. It reads from stdin and outputs line delimited JSON (or pretty JSON or YAML) to the console. In addtion it can forward the parsed objects directly to <a href="http://sematext.com/logsene">Logsene</a>.</p>
<p>Test your patterns:</p>
<pre><code>cat myapp.log | bin/logagent -y -n myapp -f mypatterns.yml
</code></pre>

<h1 id="related-packages">Related packages</h1>
<ul>
<li><a href="https://github.com/sematext/sematext-agent-docker">Sematext Agent for Docker</a> - collects metrics, events and logs from Docker API and CoreOS. Logagent-js is a component of sematext-agent-docker. More Information: <a href="http://blog.sematext.com/2015/08/12/docker-log-management/">Innovative Docker Log Management</a></li>
<li><a href="https://github.com/sematext/logsene-cli">Logsene-CLI</a> - Enables searching Logsene log entries from the command-line. </li>
<li><a href="https://github.com/sematext/spm-agent-nodejs">SPM Agent for Node.js</a> - collects performance metrics for Node and io.js applications</li>
<li><a href="https://github.com/sematext/spm-metrics-js">Custom Metrics</a> - Custom Metrics for SPM </li>
<li><a href="https://github.com/sematext/winston-logsene">Winston-Logsene</a> - Logging for Node.js - Winston transport layer for Logsene</li>
</ul>
<h1 id="support">Support</h1>
<ul>
<li>Twitter: <a href="http://www.twitter.com/sematext">@sematext</a></li>
<li>Blog: <a href="http://blog.sematext.com">blog.sematext.com</a></li>
<li>Homepage: <a href="http://www.sematext.com">www.sematext.com</a></li>
</ul></div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>

        <script src="./js/jquery-1.10.2.min.js"></script>
        <script src="./js/bootstrap-3.0.3.min.js"></script>
        <script src="./js/highlight.pack.js"></script>
        <script>var base_url = '.';</script>
        <script data-main="./mkdocs/js/search.js" src="./mkdocs/js/require.js"></script>
        <script src="./js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>

    </body>
</html>

<!--
MkDocs version : 0.15.3
Build Date UTC : 2016-05-09 08:07:16.105829
-->
